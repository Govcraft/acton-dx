-- Create {{table_name}} table
-- Generated by acton-htmx scaffold

CREATE TABLE {{table_name}} (
    id BIGSERIAL PRIMARY KEY,
    {{#each fields}}
    {{column_name}} {{sql_type}}{{#unless optional}} NOT NULL{{/unless}},
    {{/each}}
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

{{#each unique_fields}}
-- Add unique constraint for {{name}}
ALTER TABLE {{../table_name}} ADD CONSTRAINT {{../table_name}}_{{name}}_unique UNIQUE ({{column_name}});
{{/each}}

{{#each indexed_fields}}
-- Add index for {{name}}
CREATE INDEX {{../table_name}}_{{name}}_idx ON {{../table_name}} ({{column_name}});
{{/each}}

{{#each foreign_keys}}
-- Add foreign key for {{field_name}}
ALTER TABLE {{../table_name}}
    ADD CONSTRAINT {{../table_name}}_{{field_name}}_fkey
    FOREIGN KEY ({{column_name}})
    REFERENCES {{referenced_table}}(id)
    ON DELETE CASCADE;

-- Add index for foreign key
CREATE INDEX {{../table_name}}_{{field_name}}_idx ON {{../table_name}} ({{column_name}});
{{/each}}

-- Trigger to automatically update updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_{{table_name}}_updated_at
    BEFORE UPDATE ON {{table_name}}
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
